# 每日好大夫医生信息抓取任务

## 任务目标

自动抓取6个医院123个科室的医生详细信息，每天执行一次，逐个科室处理。

## 执行流程

### 1. 检查进度

运行进度跟踪脚本，获取下一个待抓取的科室：

```bash
python3 /home/ubuntu/medibridge/scripts/track_progress.py
```

如果所有科室已完成，任务结束。

### 2. 读取技能文档

使用 `/home/ubuntu/skills/haodf-doctor-scraper/SKILL.md` 技能进行抓取。

### 3. 抓取当前科室

**科室信息**：从进度跟踪系统获取
- 医院名称
- 科室名称  
- 科室URL

**抓取策略**：
1. 访问科室页面
2. **必须滚动到底部**确保加载所有医生
3. 提取医生列表（姓名、职称、医生ID）
4. 将医生列表分组，**每10个医生为一组**
5. 使用 `map` 工具并行抓取每组医生的详细信息
6. 跳过无个人简介的医生

**14个字段**：
1. 医院
2. 科室
3. 姓名
4. 职称
5. 专业方向
6. 专业擅长
7. 个人简介
8. 社会任职
9. 科研成果
10. 治疗经验（右侧边栏，需特殊处理）
11. 疗效满意度
12. 态度满意度
13. 病友推荐度
14. 医生介绍页URL

### 4. 处理验证码

如果遇到验证码（CAPTCHA）：
1. 立即停止当前抓取
2. 保存已抓取的数据到临时文件
3. 生成Excel文件
4. 推送到GitHub
5. 使用 `message` 工具通知用户：
   - 科室名称
   - 已成功抓取的医生数量
   - 遇到验证码的时间
   - GitHub推送状态

### 5. 保存数据

**临时文件**：`/home/ubuntu/medibridge/data/hospitals/{医院}_{科室}_医生信息_临时.txt`

**Excel文件**：`/home/ubuntu/medibridge/data/hospitals/{医院}_{科室}_医生信息_{日期}.xlsx`

使用技能提供的脚本：
```bash
python3 /home/ubuntu/skills/haodf-doctor-scraper/scripts/parse_to_excel.py \
    临时文件路径 \
    Excel文件路径
```

### 6. 推送到GitHub

```bash
cd /home/ubuntu/medibridge
git add data/hospitals/{医院}_{科室}_医生信息_{日期}.xlsx
git commit -m "Add {医院} {科室} doctor data - {日期}"
git push origin main
```

### 7. 更新进度

使用进度跟踪系统记录完成状态：
```python
from track_progress import ProgressTracker
tracker = ProgressTracker()
tracker.save_progress(department, 'success', '成功抓取N位医生')
# 或
tracker.save_progress(department, 'captcha', '遇到验证码，已保存M位医生数据')
```

### 8. 继续下一个科室

如果没有遇到验证码，继续抓取下一个科室。
如果遇到验证码，停止任务并通知用户。

## 重要注意事项

1. **每次只抓取一个科室** - 避免触发反爬虫机制
2. **科室内分批处理** - 每10个医生为一组并行抓取
3. **滚动到底部** - 确保加载所有医生
4. **跳过无简介医生** - 节省时间
5. **及时保存数据** - 遇到验证码立即保存
6. **推送到GitHub** - 每个科室完成后立即推送
7. **进度追踪** - 自动检查已抓取和未抓取的科室

## 数据质量标准

- 基本字段（1-5）：100%完整
- 专业字段（6-7）：95%完整
- 学术字段（8-9）：85%完整
- 治疗经验（10）：30-50%完整（右侧边栏）
- 评分字段（11-13）：100%完整
- URL（14）：100%完整

## 错误处理

- **浏览器连接失败**：等待3秒后重试，最多3次
- **页面加载超时**：使用 `browser_view` 等待加载
- **验证码**：立即停止，保存数据，通知用户
- **医生页面404**：跳过该医生，记录到日志

## 执行时间

每天凌晨2点（北京时间）自动执行。

## 预计完成时间

- 每个科室平均10-20位医生
- 每位医生抓取时间约10-15秒
- 每个科室预计3-5分钟
- 123个科室预计需要6-10小时（分多天完成）
- 遇到验证码会暂停，需要人工确认后继续
